___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Piano Analytics by Stape",
  "categories": [
    "ANALYTICS", 
    "ATTRIBUTION", 
    "CONVERSIONS"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "Stape",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Use this Tag to send data to Piano Analytics using an incoming request in the Piano Analytics or GA4 schema.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "RADIO",
    "name": "eventType",
    "displayName": "Event Name Setup Method",
    "radioItems": [
      {
        "value": "inherit",
        "displayValue": "Inherit from client",
        "help": "This option uses the event name from the incoming request.\n\u003cbr/\u003e\n\u003cbr/\u003e\nIf the request follows the \u003cb\u003ePiano Analytics\u003c/b\u003e event schema, the tag will use the event name as-is.\n\u003cbr/\u003e\n\u003cbr/\u003e\nIf the request follows the \u003cb\u003eGoogle Analytics 4 (GA4)\u003c/b\u003e schema, the following mappings will be applied to convert GA4 event names into Piano Analytics equivalents:\n\u003cbr/\u003e\n\u003cul\u003e\n\u003cli\u003epage_view → page.display\u003c/li\u003e\n\u003cli\u003esearch → internal_search_result.display\u003c/li\u003e\n\u003cli\u003eview_search_results → internal_search_result.display\u003c/li\u003e\n\u003cli\u003eview_item_list → product.display\u003c/li\u003e\n\u003cli\u003eview_item → product.page_display\u003c/li\u003e\n\u003cli\u003eadd_to_cart → product.add_to_cart\u003c/li\u003e\n\u003cli\u003eremove_from_cart → product.remove_from_cart\u003c/li\u003e\n\u003cli\u003eview_cart → cart.display\u003c/li\u003e\n\u003cli\u003eadd_shipping_info → cart.delivery\u003c/li\u003e\n\u003cli\u003eadd_payment_info → cart.payment\u003c/li\u003e\n\u003cli\u003epurchase → transaction.confirmation\u003c/li\u003e\n\u003cli\u003eview_promotion → self_promotion.impression\u003c/li\u003e\n\u003cli\u003eselect_promotion → self_promotion.click\u003c/li\u003e\n\u003c/ul\u003e"
      },
      {
        "value": "custom",
        "displayValue": "Custom",
        "subParams": [
          {
            "type": "TEXT",
            "name": "eventName",
            "displayName": "Event Name",
            "simpleValueType": true,
            "help": "",
            "enablingConditions": [
              {
                "paramName": "eventType",
                "paramValue": "custom",
                "type": "EQUALS"
              }
            ]
          }
        ]
      }
    ],
    "simpleValueType": true,
    "defaultValue": "inherit"
  },
  {
    "type": "TEXT",
    "name": "collectionDomain",
    "displayName": "Collection Domain",
    "simpleValueType": true,
    "help": "On the Piano Analytics Dashboard, go to \u003ci\u003eTagging\u003c/i\u003e → \u003ci\u003eCollection Domains\u003c/i\u003e.\n\u003cbr/\u003e\n\u003cbr/\u003e\n\u003ca href\u003d\"https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/collection-methods#piano-collection-endpoint\"\u003eLearn more\u003c/\u003e.",
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          ".+\\.pa-cd\\.com$"
        ],
        "errorMessage": ""
      },
      {
        "type": "NON_EMPTY"
      }
    ],
    "valueHint": "xxxx.pa-cd.com"
  },
  {
    "type": "TEXT",
    "name": "siteId",
    "displayName": "Site ID",
    "simpleValueType": true,
    "valueHint": "123456789",
    "help": "Go to Piano Analytics dashboard and use the number in the \u003ci\u003eID\u003c/i\u003e column for the desired website.\n\u003cbr/\u003e\nIf not set, it will inherit from the Event Data parameter \u003ci\u003ex-pa-site-id\u003c/i\u003e.\n\u003cbr/\u003e\n\u003cbr/\u003e\n\u003ca href\u003d\"https://analytics-docs.piano.io/en/analytics/v1/dashboard\n\"\u003eLearn more\u003c/\u003e."
  },
  {
    "type": "TEXT",
    "name": "idClient",
    "displayName": "Visitor ID",
    "simpleValueType": true,
    "valueHint": "ma11t8f7wqcmriz4",
    "help": "Unique identifier of the visitor.\n\u003cbr/\u003e\nIf not set, it will inherit from the Event Data parameters \u003ci\u003eclient_id\u003c/i\u003e or \u003ci\u003ex-pa-idclient\u003c/i\u003e.\n\u003cbr/\u003e\n\u003cbr/\u003e\nFormat: 16 characters string or GUID/UUID string.\n\u003cbr/\u003e\nExamples:\n\u003cul\u003e\n\u003cli\u003ema11t8f7wqcmriz4\u003c/li\u003e (16 characters string)\n\u003cli\u003e97C7DB4E-4514-4B8E-B693-BD6B57043CC1\u003c/li\u003e (GUID/UUID string)\n\u003c/ul\u003e\n\u003cbr/\u003e\n\u003ca href\u003d\"https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/visitor-identification\"\u003eLearn more\u003c/a\u003e."
  },
  {
    "type": "SELECT",
    "name": "redactIpAddress",
    "displayName": "Redact Visitor IP Address",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": true,
        "displayValue": "true"
      },
      {
        "value": false,
        "displayValue": "false"
      }
    ],
    "simpleValueType": true,
    "defaultValue": false,
    "help": "Removes the visitor\u0027s IP address from the event data.\nUse with caution, enabling this may negatively impact reporting accuracy and data quality."
  },
  {
    "type": "SELECT",
    "name": "useOptimisticScenario",
    "displayName": "Use Optimistic Scenario",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": true,
        "displayValue": "true"
      },
      {
        "value": false,
        "displayValue": "false"
      }
    ],
    "simpleValueType": true,
    "help": "The tag will call gtmOnSuccess() without waiting for a response from the API. This will speed up sGTM response time however your tag will always return the status fired successfully even in case it is not.",
    "defaultValue": false
  },
  {
    "type": "GROUP",
    "name": "eventParametersGroup",
    "displayName": "Event Parameters",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "LABEL",
        "name": "eventParametersWarningCartIdLabel",
        "displayName": "\u003cb\u003eBy default, the tag does not retrieve any value for the \u003ci\u003ecart_id\u003c/i\u003e property, which is required for most Piano Analytics ecommerce events.\n\u003cbr /\u003e\nIt is strongly recommended to configure a mapping for this property, especially if you are NOT using the Piano Analytics schema in the incoming request to trigger the events (e.g., when using the GA4 schema).\u003c/b\u003e\n\u003cbr /\u003e\nIf no \u003ci\u003ecart_id\u003c/i\u003e mapping is provided, the tag will fall back to using the \u003ci\u003etransaction_id\u003c/i\u003e as the \u003ci\u003ecart_id\u003c/i\u003e. However, this fallback is \u003cb\u003enot recommended\u003c/b\u003e and should only be used as a last resort.\n\u003cbr /\u003e\n\u003cbr /\u003e"
      },
      {
        "type": "GROUP",
        "name": "eventParametersExcludeGroup",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "SIMPLE_TABLE",
            "name": "eventParametersExcludeList",
            "displayName": "Parameters to Exclude",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Name",
                "name": "name",
                "type": "TEXT",
                "isUnique": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              }
            ],
            "help": "Event parameters listed here will not be sent to Piano Analytics."
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "eventParametersAddOrEditGroup",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "SIMPLE_TABLE",
            "name": "eventParametersAddOrEditList",
            "displayName": "Parameters to Add / Edit",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Name",
                "name": "name",
                "type": "TEXT",
                "isUnique": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              },
              {
                "defaultValue": "",
                "displayName": "Value",
                "name": "value",
                "type": "TEXT",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              }
            ],
            "help": "Event parameters listed here will be added to the event sent to Piano Analytics. If the event parameter is already included, then the value will be replaced with the specified value."
          }
        ]
      }
    ]
  },
  {
    "displayName": "Logs Settings",
    "name": "logsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  },
  {
    "displayName": "BigQuery Logs Settings",
    "name": "bigQueryLogsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "bigQueryLogType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log to BigQuery"
          },
          {
            "value": "always",
            "displayValue": "Log to BigQuery"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "no"
      },
      {
        "type": "GROUP",
        "name": "logsBigQueryConfigGroup",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "logBigQueryProjectId",
            "displayName": "BigQuery Project ID",
            "simpleValueType": true,
            "help": "Optional.  \u003cbr\u003e\u003cbr\u003e  If omitted, it will be retrieved from the environment variable \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e where the server container is running. If the server container is running on Google Cloud, \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e will already be set to the Google Cloud project\u0027s ID."
          },
          {
            "type": "TEXT",
            "name": "logBigQueryDatasetId",
            "displayName": "BigQuery Dataset ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "logBigQueryTableId",
            "displayName": "BigQuery Table ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "bigQueryLogType",
            "paramValue": "always",
            "type": "EQUALS"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const BigQuery = require('BigQuery');
const encodeUriComponent = require('encodeUriComponent');
const getAllEventData = require('getAllEventData');
const getContainerVersion = require('getContainerVersion');
const getRequestHeader = require('getRequestHeader');
const getTimestampMillis = require('getTimestampMillis');
const getType = require('getType');
const JSON = require('JSON');
const logToConsole = require('logToConsole');
const makeInteger = require('makeInteger');
const makeNumber = require('makeNumber');
const makeString = require('makeString');
const sendHttpRequest = require('sendHttpRequest');

/**********************************************************************************************/

const traceId = getRequestHeader('trace-id');

const eventData = getAllEventData();

const useOptimisticScenario = isUIFieldTrue(data.useOptimisticScenario);

const url = eventData.page_location || getRequestHeader('referer');
if (url && url.lastIndexOf('https://gtm-msr.appspot.com/', 0) === 0) {
  return data.gtmOnSuccess();
}

let mappedEventData = mapEventData(data, eventData);
mappedEventData = validateMappedEventData(mappedEventData);

if (!mappedEventData.length) {
  return data.gtmOnFailure();
}

sendRequest(mappedEventData);

if (useOptimisticScenario) {
  return data.gtmOnSuccess();
}

/**********************************************************************************************/
// Vendor related functions

function mapEventName(data, eventData) {
  if (data.eventType === 'inherit') {
    const eventName = eventData.event_name;
    const DEFAULT_GA_TO_PA_EVENTS_MAPPING = {
      // Standard events
      page_view: 'page.display',
      search: 'internal_search_result.display',
      view_search_results: 'internal_search_result.display',
      // Ecommerce events
      view_item_list: 'product.display',
      view_item: 'product.page_display',
      add_to_cart: 'product.add_to_cart',
      remove_from_cart: 'product.remove_from_cart',
      view_cart: 'cart.display',
      add_shipping_info: 'cart.delivery',
      add_payment_info: 'cart.payment',
      purchase: 'transaction.confirmation',
      view_promotion: 'self_promotion.impression',
      select_promotion: 'self_promotion.click'
    };

    if (DEFAULT_GA_TO_PA_EVENTS_MAPPING[eventName]) {
      return DEFAULT_GA_TO_PA_EVENTS_MAPPING[eventName];
    }

    return eventName;
  }

  return data.eventName;
}

function mapChildEventName(parentEventName) {
  const DEFAULT_PA_PARENT_TO_PA_CHILD_EVENTS_MAPPING = {
    'transaction.confirmation': 'product.purchased',
    'cart.display': 'product.display'
  };

  return DEFAULT_PA_PARENT_TO_PA_CHILD_EVENTS_MAPPING[parentEventName];
}

function addNonPAEcommerceData(eventData, mappedEventData) {
  const event = mappedEventData[0];
  const cartOrTransactionEvent =
    event.name.indexOf('cart.') !== -1 || event.name.indexOf('transaction.') !== -1;

  // self_promotion.* or publisher.* events
  if (eventData.onsitead_type) event.data.onsitead_type = makeString(eventData.onsitead_type);
  if (eventData.creative_name) event.data.onsitead_variant = makeString(eventData.creative_name);
  if (eventData.creative_slot) event.data.onsitead_category = makeString(eventData.creative_slot);
  if (eventData.promotion_id) event.data.onsitead_campaign = makeString(eventData.promotion_id);
  if (eventData.promotion_name) event.data.onsitead_creation = makeString(eventData.promotion_name);
  if (event.name.indexOf('publisher.') === 0 && !eventData.onsitead_type) {
    event.data.onsitead_type = 'Publisher';
  } else if (event.name.indexOf('self_promotion.') === 0 && !eventData.onsitead_type) {
    event.data.onsitead_type = 'Self promotion';
  }

  if (eventData.payment_type) {
    event.data.payment_mode = eventData.payment_type;
  }

  if (eventData.shipping_tier) {
    event.data.shipping_delivery = eventData.shipping_tier;
  }
  if (isValidValue(eventData.shipping)) {
    event.data.shipping_costtaxfree = makeNumber(eventData.shipping);
  }

  if (eventData.coupon) {
    event.data.transaction_promocode =
      getType(eventData.coupon) !== 'array'
        ? makeString(eventData.coupon).split(',')
        : eventData.coupon;
  }

  if (eventData.cart_id) event.data.cart_id = eventData.cart_id;

  if (eventData.transaction_id) {
    event.data.transaction_id = eventData.transaction_id;
    if (!event.data.cart_id) event.data.cart_id = eventData.transaction_id;
  }

  if (cartOrTransactionEvent) {
    const tax = eventData.tax;
    const value = makeNumber(eventData.value);
    const valueIsValid = isValidValue(value);
    if (valueIsValid) {
      event.data.cart_turnovertaxincluded = tax ? value + makeNumber(tax) : value;
      event.data.cart_turnovertaxfree = value;
    }
  }

  // items (GA4) to items_list (PA) mapping
  const hasItems = getType(eventData.items) === 'array' && eventData.items.length > 0;
  if (hasItems) {
    // https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/standard-events#batching-similar-events
    event.data.items_list = [];
    const currencyFromItems = eventData.items[0].currency;
    let valueFromItems = 0;
    let itemsTotalQuantity = 0;

    eventData.items.forEach((item) => {
      const listItem = {};

      if (item.item_id) listItem.product_id = makeString(item.item_id);
      if (item.item_name) listItem.product = makeString(item.item_name);
      if (item.item_variant) listItem.product_variant = makeString(item.item_variant);
      if (item.coupon || item.discount) {
        const discount = item.coupon || item.discount;
        listItem.product_discount = getType(discount) !== 'boolean' ? true : discount;
      }
      if (item.item_brand) listItem.product_brand = makeString(item.item_brand);
      if (item.item_category) listItem.product_category1 = makeString(item.item_category);
      if (item.item_category2) listItem.product_category2 = makeString(item.item_category2);
      if (item.item_category3) listItem.product_category3 = makeString(item.item_category3);
      if (item.item_category4) listItem.product_category4 = makeString(item.item_category4);
      if (item.quantity) {
        const quantity = makeInteger(item.quantity);
        listItem.product_quantity = quantity;
        itemsTotalQuantity += quantity || 0;
      }
      if (item.price) {
        const price = makeNumber(item.price);
        const quantity = makeInteger(item.quantity);
        listItem.product_pricetaxfree = makeNumber(price);
        valueFromItems += quantity ? quantity * price : price;
      }

      // self_promotion.* or publisher.* events
      if (item.onsitead_type) listItem.onsitead_type = makeString(item.onsitead_type);
      if (item.creative_name) listItem.onsitead_variant = makeString(item.creative_name);
      if (item.creative_slot) listItem.onsitead_category = makeString(item.creative_slot);
      if (item.promotion_id) listItem.onsitead_campaign = makeString(item.promotion_id);
      if (item.promotion_name) listItem.onsitead_creation = makeString(item.promotion_name);
      if (event.name.indexOf('publisher.') === 0 && !listItem.onsitead_type) {
        listItem.onsitead_type = 'Publisher';
      } else if (event.name.indexOf('self_promotion.') === 0 && !listItem.onsitead_type) {
        listItem.onsitead_type = 'Self promotion';
      }

      event.data.items_list.push(listItem);
    });

    if (!event.data.cart_currency && currencyFromItems) {
      event.data.cart_currency = currencyFromItems;
    }

    if (cartOrTransactionEvent) {
      if (eventData.items.length) event.data.cart_nbdistinctproduct = eventData.items.length;
      if (itemsTotalQuantity) event.data.cart_quantity = itemsTotalQuantity;

      const tax = eventData.tax;
      const valueIsValid = isValidValue(valueFromItems);
      if (valueIsValid) {
        event.data.cart_turnovertaxincluded = tax
          ? valueFromItems + makeNumber(tax)
          : valueFromItems;
        event.data.cart_turnovertaxfree = valueFromItems;
      }
    }
  }

  return mappedEventData;
}

function addChildEventDataIfNeeded(mappedEventData) {
  const parentEvent = mappedEventData[0];

  const childEventName = mapChildEventName(parentEvent.name);
  const hasItems =
    getType(parentEvent.data.items_list) === 'array' && parentEvent.data.items_list.length > 0;

  if (childEventName && hasItems) {
    const childEvent = {
      name: childEventName,
      data: mergeObj({}, parentEvent.data) // Copy the data from the parent event
    };

    // Remove the items_list parameter from the parent event.
    parentEvent.data.items_list = undefined;

    mappedEventData.push(childEvent);
  }

  return mappedEventData;
}

function mapEventData(data, eventData) {
  const event = {
    name: mapEventName(data, eventData),
    data: eventData['x-pa-data'] || {
      device_timestamp_utc: makeInteger(getTimestampMillis() / 1000)
    }
  };
  const mappedEventData = [event];

  // Common Event Data
  if (eventData.currency) event.data.cart_currency = eventData.currency;
  if (eventData.language) {
    const language = eventData.language.replace('_', '-').split('-');
    event.data.browser_language = language[0];
    event.data.browser_language_local = language[1];
  }
  if (eventData.page_location) event.data.event_url_full = eventData.page_location;
  if (eventData.page_referrer) event.data.previous_url = eventData.page_referrer;
  if (eventData.page_title) event.data.page_title_html = eventData.page_title;
  if (eventData.screen_resolution) {
    const screenResolution = eventData.screen_resolution.split('x');
    event.data.device_screen_width = makeInteger(screenResolution[0]);
    event.data.device_screen_height = makeInteger(screenResolution[1]);
  }
  if (eventData.user_id) event.data.user_id = eventData.user_id;
  if (eventData.viewport_size) {
    const viewportSize = eventData.viewport_size.split('x');
    event.data.device_display_width = makeInteger(viewportSize[0]);
    event.data.device_display_height = makeInteger(viewportSize[1]);
  }

  // Non-standard Piano Analytics property
  if (isValidValue(eventData.value)) event.data.value = eventData.value;

  // Event Data - Non-default parameters
  if (eventData['x-ga-page_id']) event.data.pageview_id = makeString(eventData['x-ga-page_id']);
  if (eventData.search_term) event.data.ise_keyword = eventData.search_term;

  // Adds ecommerce data from incoming requests following the GA4 schema
  if (!eventData['x-pa-data']) addNonPAEcommerceData(eventData, mappedEventData);

  if (data.eventParametersExcludeList) {
    data.eventParametersExcludeList.forEach((p) => {
      if (isValidValue(event.data[p.name])) event.data[p.name] = undefined; // JSON.stringify will get rid of it
    });
  }

  if (data.eventParametersAddOrEditList) {
    data.eventParametersAddOrEditList.forEach((p) => {
      if (isValidValue(p.value)) event.data[p.name] = p.value;
    });
  }

  // Only when using an incoming request that contains an event that produces a child event (e.g. GA4 schema)
  if (!eventData['x-pa-data']) addChildEventDataIfNeeded(mappedEventData);

  return mappedEventData;
}

function validateMappedEventData(mappedEventData) {
  const ECOMMERCE_MANDATORY_PROPERTIES = {
    'product.display': ['product_id'],
    'product.page_display': ['product_id'],
    'product.add_to_cart': ['product_id'],
    'product.remove_from_cart': ['product_id'],
    'cart.creation': ['cart_id'],
    'cart.display': ['cart_id'],
    'cart.update': ['cart_id'],
    'cart.delivery': ['cart_id'],
    'cart.payment': ['cart_id'],
    'transaction.confirmation': ['cart_id', 'transaction_id'],
    'product.purchased': ['cart_id', 'product_id', 'transaction_id']
  };

  // Remove invalid event object from mappedEventData, but do not abort the tag execution in case there are multiple events and not all of them are invalid.
  return mappedEventData.filter((event) => {
    const missingMandatoryProps = { error: false, props: [] };

    const mandatoryProps = ECOMMERCE_MANDATORY_PROPERTIES[event.name];
    if (!mandatoryProps) return true;

    mandatoryProps.forEach((mandatoryProp) => {
      const missingPropAtRootLevel = !isValidValue(event.data[mandatoryProp]);
      const itemsList = event.data.items_list;
      const missingPropAtItemsListLevel = (itemsList || []).some(
        (listItem) => !isValidValue(listItem[mandatoryProp])
      );
      if (
        (missingPropAtRootLevel && !itemsList) ||
        (missingPropAtRootLevel && itemsList && missingPropAtItemsListLevel)
      ) {
        missingMandatoryProps.error = true;
        missingMandatoryProps.props.push(mandatoryProp);
      }
    });

    if (missingMandatoryProps.error) {
      log({
        Name: 'PianoAnalyticsTag',
        Type: 'Message',
        TraceId: traceId,
        EventName: event.name,
        Message: 'Event was not sent.',
        Reason: 'Mandatory parameter(s) missing: ' + missingMandatoryProps.props.join(', ')
      });
      return false;
    }
    return true;
  });
}

function getRequestUrl() {
  let requestUrl =
    'https://' + data.collectionDomain.replace('http://', '').replace('https://', '') + '/event';
  requestUrl += '?s=' + (data.siteId || eventData['x-pa-site-id']);
  requestUrl +=
    '&idclient=' + enc(data.idClient || eventData.client_id || eventData['x-pa-idclient']);

  return requestUrl;
}

function sendRequest(mappedEventData) {
  let requestUrl = getRequestUrl();

  const requestHeaders = { 'Content-Type': 'text/plain' };
  if (!isUIFieldTrue(data.redactIpAddress) && eventData.ip_override) {
    requestHeaders['X-Forwarded-For'] = eventData.ip_override;
  }
  if (eventData.user_agent) {
    requestHeaders['User-Agent'] = eventData.user_agent;
  }
  if (mappedEventData[0].data.event_url_full) {
    // https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/collection-api
    // "Address of the page sending the data"
    requestHeaders['Referer'] = mappedEventData[0].data.event_url_full;
  }

  const requestBody = {
    events: mappedEventData
  };

  const eventNames = mappedEventData.map((e) => e.name).join('|');
  log({
    Name: 'PianoAnalyticsTag',
    Type: 'Request',
    TraceId: traceId,
    EventName: eventNames,
    RequestMethod: 'POST',
    RequestUrl: requestUrl,
    RequestHeaders: requestHeaders,
    RequestBody: requestBody
  });

  sendHttpRequest(
    requestUrl,
    {
      headers: requestHeaders,
      method: 'POST'
    },
    JSON.stringify(requestBody)
  )
    .then((response) => {
      log({
        Name: 'PianoAnalyticsTag',
        Type: 'Response',
        TraceId: traceId,
        EventName: eventNames,
        ResponseStatusCode: response.statusCode,
        ResponseHeaders: response.headers,
        ResponseBody: response.body
      });

      if (!useOptimisticScenario) {
        if (response.statusCode >= 200 && response.statusCode < 300) {
          data.gtmOnSuccess();
        } else {
          data.gtmOnFailure();
        }
      }
    })
    .catch(() => {
      if (!useOptimisticScenario) {
        data.gtmOnFailure();
      }
    });
}

/**********************************************************************************************/
// Helpers

function enc(data) {
  return encodeUriComponent(makeString(data || ''));
}

function mergeObj(target, source) {
  for (const key in source) {
    if (source.hasOwnProperty(key)) target[key] = source[key];
  }
  return target;
}

function isValidValue(value) {
  const valueType = getType(value);
  return valueType !== 'null' && valueType !== 'undefined' && value !== '';
}

function isUIFieldTrue(field) {
  return [true, 'true'].indexOf(field) !== -1;
}

function log(rawDataToLog) {
  const logDestinationsHandlers = {};
  if (determinateIsLoggingEnabled()) logDestinationsHandlers.console = logConsole;
  if (determinateIsLoggingEnabledForBigQuery()) logDestinationsHandlers.bigQuery = logToBigQuery;

  // Key mappings for each log destination
  const keyMappings = {
    // No transformation for Console is needed.
    bigQuery: {
      Name: 'tag_name',
      Type: 'type',
      TraceId: 'trace_id',
      EventName: 'event_name',
      RequestMethod: 'request_method',
      RequestUrl: 'request_url',
      RequestBody: 'request_body',
      ResponseStatusCode: 'response_status_code',
      ResponseHeaders: 'response_headers',
      ResponseBody: 'response_body'
    }
  };

  for (const logDestination in logDestinationsHandlers) {
    const handler = logDestinationsHandlers[logDestination];
    if (!handler) continue;

    const mapping = keyMappings[logDestination];
    const dataToLog = mapping ? {} : rawDataToLog;
    // Map keys based on the log destination
    if (mapping) {
      for (const key in rawDataToLog) {
        const mappedKey = mapping[key] || key; // Fallback to original key if no mapping exists
        dataToLog[mappedKey] = rawDataToLog[key];
      }
    }

    handler(dataToLog);
  }
}

function logConsole(dataToLog) {
  logToConsole(JSON.stringify(dataToLog));
}

function logToBigQuery(dataToLog) {
  const connectionInfo = {
    projectId: data.logBigQueryProjectId,
    datasetId: data.logBigQueryDatasetId,
    tableId: data.logBigQueryTableId
  };

  // timestamp is required.
  dataToLog.timestamp = getTimestampMillis();

  // Columns with type JSON need to be stringified.
  ['request_body', 'response_headers', 'response_body'].forEach((p) => {
    // GTM Sandboxed JSON.parse returns undefined for malformed JSON but throws post-execution, causing execution failure.
    // If fixed, could use: dataToLog[p] = JSON.stringify(JSON.parse(dataToLog[p]) || dataToLog[p]);
    dataToLog[p] = JSON.stringify(dataToLog[p]);
  });

  // assertApi doesn't work for 'BigQuery.insert()'. It's needed to convert BigQuery into a function when testing.
  // Ref: https://gtm-gear.com/posts/gtm-templates-testing/
  const bigquery =
    getType(BigQuery) === 'function' ? BigQuery() /* Only during Unit Tests */ : BigQuery;
  bigquery.insert(connectionInfo, [dataToLog], { ignoreUnknownValues: true });
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
    containerVersion &&
    (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}

function determinateIsLoggingEnabledForBigQuery() {
  if (data.bigQueryLogType === 'no') return false;
  return data.bigQueryLogType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.pa-cd.com/event?*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_bigquery",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedTables",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "datasetId"
                  },
                  {
                    "type": 1,
                    "string": "tableId"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: GA4 - Request is NOT sent if mandatory property is missing from event payload
    and payload has only 1 event
  code: |-
    mockData.eventType = 'inherit';
    mockGetAllEventDataWithGAData({ event_name: 'view_item', items: [{ item_name: 'test' }] });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
    assertApi('sendHttpRequest').wasNotCalled();
- name: PA - Request is NOT sent if mandatory property is missing from event payload
    and payload has only 1 event
  code: |-
    mockData.eventType = 'inherit';
    mockGetAllEventDataWithPAData({ event_name: 'product.display', 'x-pa-data': { product_id: undefined } });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('gtmOnFailure').wasCalled();
- name: GA4 (only) - Request is sent if mandatory property is missing from event payload,
    payload has more than 1 event and NOT ALL events are invalid
  code: "mockData.eventType = 'inherit';\nmockGetAllEventDataWithGAData({ \n  items:\
    \ [\n    {\n      // item_id: \"SKU_12345\",\n      item_name: \"Stan and Friends\
    \ Tee\",\n      affiliation: \"Google Merchandise Store\",\n      coupon: \"SUMMER_FUN\"\
    ,\n      discount: 2.22,\n      index: 0,\n      item_brand: \"Google\",\n   \
    \   item_category: \"Apparel\",\n      item_category2: \"Adult\",\n      item_category3:\
    \ \"Shirts\",\n      item_category4: \"Crew\",\n      item_category5: \"Short\
    \ sleeve\",\n      item_list_id: \"related_products\",\n      item_list_name:\
    \ \"Related Products\",\n      item_variant: \"green\",\n      location_id: \"\
    ChIJIQBpAG2ahYAR_6128GcTUEo\",\n      price: 10.01,\n      quantity: 3\n    },\n\
    \    {\n      // item_id: \"SKU_12346\",\n      item_name: \"Google Grey Women's\
    \ Tee\",\n      affiliation: \"Google Merchandise Store\",\n      coupon: \"SUMMER_FUN\"\
    ,\n      discount: 3.33,\n      index: 1,\n      item_brand: \"Google\",\n   \
    \   item_category: \"Apparel\",\n      item_category2: \"Adult\",\n      item_category3:\
    \ \"Shirts\",\n      item_category4: \"Crew\",\n      item_category5: \"Short\
    \ sleeve\",\n      item_list_id: \"related_products\",\n      item_list_name:\
    \ \"Related Products\",\n      item_variant: \"gray\",\n      location_id: \"\
    ChIJIQBpAG2ahYAR_6128GcTUEo\",\n      price: 21.01,\n      promotion_id: \"P_12345\"\
    ,\n      promotion_name: \"Summer Sale\",\n      quantity: 2\n    }\n  ] \n});\n\
    \n// 'product.purchased' should be removed\nconst expectedRequestBody = {\n  events:\
    \ [\n    {\n      name: 'transaction.confirmation',\n      data: {\n        device_timestamp_utc:\
    \ 1746111402,\n        cart_currency: 'USD',\n        browser_language: 'en',\n\
    \        browser_language_local: 'us',\n        event_url_full: 'https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/how-it-works',\n\
    \        previous_url: 'https://example.com/',\n        page_title_html: 'Example\
    \ Domain',\n        device_screen_width: 1512,\n        device_screen_height:\
    \ 982,\n        value: 72.05,\n        pageview_id: '1746024331702',\n       \
    \ shipping_costtaxfree: 5.99,\n        transaction_promocode: ['SUMMER_SALE'],\n\
    \        transaction_id: 'T_12345',\n        cart_id: 'T_12345',\n        cart_turnovertaxfree:\
    \ 72.05000000000001,\n        cart_turnovertaxincluded: 75.65,\n        cart_nbdistinctproduct:\
    \ 2,\n        cart_quantity: 5\n      }\n    }\n  ]\n};\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  const requestBodyParsed =\
    \ JSON.parse(requestBody);\n  assertThat(requestBodyParsed).isEqualTo(expectedRequestBody);\
    \ // It should contain only one event. The one which has all required properties\n\
    \  \n  return {\n    then: (callback) => { \n      callback({ statusCode: 200\
    \ });\n      return {\n        then: () => {},\n        catch: () => {}\n    \
    \  };\n    },\n    catch: (callback) => callback()\n  };\n});\n\nrunCode(mockData);\n\
    \nassertApi('gtmOnSuccess').wasCalled();\nassertApi('gtmOnFailure').wasNotCalled();"
- name: Request URL is correctly built
  code: "const baseSiteId = 'baseSiteId';\nconst baseIdClient = 'baseIdClient';\n\n\
    [\n  { \n    prepare: () => {\n      mockData.idClient = baseIdClient;\n     \
    \ const siteId = 'siteIdFromData';\n      mockData.siteId = siteId;\n      mockGetAllEventDataWithPAData({\
    \ 'x-pa-site-id': undefined });\n      return {\n        expectedSiteId: siteId,\n\
    \        expectedIdClient: baseIdClient\n      };\n    }\n  },\n  { \n    prepare:\
    \ () => {\n      mockData.idClient = baseIdClient;\n      const siteId = 'siteIdFromPAEventData';\n\
    \      mockGetAllEventDataWithPAData({ 'x-pa-site-id': siteId });\n      mockData.siteId\
    \ = undefined;\n      return {\n        expectedSiteId: siteId,\n        expectedIdClient:\
    \ baseIdClient\n      };\n    }\n  },\n  { \n    prepare: () => {\n      mockData.siteId\
    \ = baseSiteId;\n      const idClient = 'idClientFromData';\n      mockData.idClient\
    \ = idClient;\n      mockGetAllEventDataWithPAData({ 'client_id': undefined, 'x-pa-idclient':\
    \ undefined });\n      return {\n        expectedSiteId: baseSiteId,\n       \
    \ expectedIdClient: idClient\n      };\n    }    \n  },\n  { \n    prepare: ()\
    \ => {\n      mockData.siteId = baseSiteId;\n      const idClient = 'idClientFromEventDataClientId';\n\
    \      mockData.idClient = undefined;\n      mockGetAllEventDataWithPAData({ 'client_id':\
    \ idClient, 'x-pa-idclient': undefined });\n      return {\n        expectedSiteId:\
    \ baseSiteId,\n        expectedIdClient: idClient\n      };\n    }    \n  },\n\
    \  { \n    prepare: () => {\n      mockData.siteId = baseSiteId;\n      const\
    \ idClient = 'idClientFromEventData';\n      mockData.idClient = undefined;\n\
    \      mockGetAllEventDataWithPAData({ 'client_id': undefined, 'x-pa-idclient':\
    \ idClient });\n      return {\n        expectedSiteId: baseSiteId,\n        expectedIdClient:\
    \ idClient\n      };\n    }    \n  }\n].forEach((scenario, index) => {\n  \n \
    \ const expectedValues = scenario.prepare();\n  \n  mock('sendHttpRequest', (requestUrl,\
    \ requestOptions, requestBody) => {\n    const expectedRequestUrl = buildExpectedRequestUrl(expectedCollectionDomain,\
    \ expectedValues.expectedSiteId, expectedValues.expectedIdClient);\n\n    const\
    \ requestUrlMatchesExpectedUrl = requestUrl === expectedRequestUrl;\n    \n  \
    \  if (!requestUrlMatchesExpectedUrl) fail(index +' requestUrl has not been properly\
    \ built. Actual: ' + requestUrl + '. Expected: ' + expectedRequestUrl);\n    \n\
    \    return {\n      then: (callback) => { \n        callback({ statusCode: 200\
    \ });\n        return {\n          then: () => {},\n          catch: () => {}\n\
    \        };\n      },\n      catch: (callback) => callback()\n    };\n  });\n\
    \  \n  runCode(mockData);\n});"
- name: PA - Inherited Event Name request is sent successfully if using Event Data
    from Piano Analytics Client - gtmOnSuccess
  code: "mockData.eventType = 'inherit';\nconst paEventData = mockGetAllEventDataWithPAData();\n\
    \nconst expectedRequestUrl = buildExpectedRequestUrl(expectedCollectionDomain,\
    \ expectedSiteId, paEventData.client_id);\nconst expectedRequestOptions = {\n\
    \  headers: {\n    'Content-Type': 'text/plain',\n    'X-Forwarded-For': expectedIpOverride,\n\
    \    'User-Agent': expectedUserAgent,\n    Referer: expectedPageLocation\n  },\n\
    \  method: 'POST'\n};\nconst expectedRequestBody = {\n  events: [\n    {\n   \
    \   name: 'transaction.confirmation',\n      data: {\n        cart_id: 'LAPW221C',\n\
    \        cart_currency: 'EUR',\n        cart_turnovertaxincluded: 1399.9,\n  \
    \      cart_creation_utc: 1666196008,\n        cart_turnovertaxfree: 1120.9,\n\
    \        cart_quantity: 1,\n        cart_nbdistinctproduct: 1,\n        shipping_delivery:\
    \ 'Express',\n        shipping_costtaxincluded: 11.99,\n        shipping_costtaxfree:\
    \ 10.99,\n        transaction_id: 'TR221SI',\n        transaction_promocode: ['REDUC10'],\n\
    \        transaction_status: 'charged',\n        transaction_firstpurchase: true,\n\
    \        payment_mode: 'Credit card',\n        visitor_privacy_consent: true,\n\
    \        visitor_privacy_mode: 'optin',\n        event_collection_platform: 'js',\n\
    \        event_collection_version: '6.15.2',\n        device_timestamp_utc: 1746111402000,\n\
    \        device_local_hour: 1746111402000,\n        device_hour: 11,\n       \
    \ pageview_id: 'ma5ghrnf62e0irie',\n        content_title: 'Piano Analytics Developers\
    \ Documentation',\n        content_description: 'Events and properties',\n   \
    \     cookie_creation_date: '2025-04-28T00:00:00.000Z',\n        has_access: 'anon',\n\
    \        device_screen_width: 1512,\n        device_screen_height: 982,\n    \
    \    device_display_width: 317,\n        device_display_height: 772,\n       \
    \ browser_language: 'en',\n        browser_language_local: 'us',\n        previous_url:\
    \ 'https://example.com/',\n        page_title_html:\n          'How it works?\
    \ | Piano Analytics Developers Documentation',\n        event_url_full:\n    \
    \      'https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/how-it-works',\n\
    \        ch_ua: [\n          { brand: 'Google Chrome', version: '135' },\n   \
    \       { brand: 'Not-A.Brand', version: '8' },\n          { brand: 'Chromium',\
    \ version: '135' }\n        ],\n        ch_ua_arch: 'arm',\n        ch_ua_bitness:\
    \ '64',\n        ch_ua_full_version_list: [\n          { brand: 'Google Chrome',\
    \ version: '135.0.7049.115' },\n          { brand: 'Not-A.Brand', version: '8.0.0.0'\
    \ },\n          { brand: 'Chromium', version: '135.0.7049.115' }\n        ],\n\
    \        ch_ua_mobile: false,\n        ch_ua_model: '',\n        ch_ua_platform:\
    \ 'macOS',\n        ch_ua_platform_version: '15.2.0',\n        ch_ua_full_version:\
    \ '135.0.7049.115',\n        user_id: 'userid123',\n        user_category: 'testcategory',\n\
    \        user_recognition: false,\n        value: 1120.9\n      }\n    }\n  ]\n\
    };\n\nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody) => {\n\
    \  assertThat(requestUrl).isEqualTo(expectedRequestUrl);\n  assertThat(requestOptions).isEqualTo(expectedRequestOptions);\n\
    \  const requestBodyParsed = JSON.parse(requestBody);\n  assertThat(requestBodyParsed).isEqualTo(expectedRequestBody);\n\
    \  \n  return {\n    then: (callback) => { \n      callback({ statusCode: 200\
    \ });\n      return {\n        then: () => {},\n        catch: () => {}\n    \
    \  };\n    },\n    catch: (callback) => callback()\n  };\n});\n\nrunCode(mockData);\n\
    \nassertApi('gtmOnSuccess').wasCalled();\nassertApi('gtmOnFailure').wasNotCalled();"
- name: GA4 - Inherited Event Name request is sent successfully if using Event Data
    from other client - gtmOnSuccess
  code: "mockData.eventType = 'inherit';\nconst gaEventData = mockGetAllEventDataWithGAData();\n\
    \nconst expectedRequestUrl = buildExpectedRequestUrl(expectedCollectionDomain,\
    \ expectedSiteId, gaEventData.client_id);\nconst expectedRequestOptions = {\n\
    \  headers: {\n    'Content-Type': 'text/plain',\n    'X-Forwarded-For': expectedIpOverride,\n\
    \    'User-Agent': expectedUserAgent,\n    Referer: expectedPageLocation\n  },\n\
    \  method: 'POST'\n};\nconst expectedRequestBody = {\n  events: [\n    {\n   \
    \   name: 'transaction.confirmation',\n      data: {\n        device_timestamp_utc:\
    \ 1746111402,\n        cart_currency: 'USD',\n        browser_language: 'en',\n\
    \        browser_language_local: 'us',\n        event_url_full:\n          'https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/how-it-works',\n\
    \        previous_url: 'https://example.com/',\n        page_title_html: 'Example\
    \ Domain',\n        device_screen_width: 1512,\n        device_screen_height:\
    \ 982,\n        value: 72.05,\n        pageview_id: '1746024331702',\n       \
    \ shipping_costtaxfree: 5.99,\n        transaction_promocode: ['SUMMER_SALE'],\n\
    \        transaction_id: 'T_12345',\n        cart_id: 'T_12345',\n        cart_turnovertaxfree:\
    \ 72.05000000000001,\n        cart_turnovertaxincluded: 75.65,\n        cart_nbdistinctproduct:\
    \ 2,\n        cart_quantity: 5\n      }\n    },\n    {\n      name: 'product.purchased',\n\
    \      data: {\n        device_timestamp_utc: 1746111402,\n        cart_currency:\
    \ 'USD',\n        browser_language: 'en',\n        browser_language_local: 'us',\n\
    \        event_url_full:\n          'https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/how-it-works',\n\
    \        previous_url: 'https://example.com/',\n        page_title_html: 'Example\
    \ Domain',\n        device_screen_width: 1512,\n        device_screen_height:\
    \ 982,\n        value: 72.05,\n        pageview_id: '1746024331702',\n       \
    \ shipping_costtaxfree: 5.99,\n        transaction_promocode: ['SUMMER_SALE'],\n\
    \        transaction_id: 'T_12345',\n        cart_id: 'T_12345',\n        cart_turnovertaxfree:\
    \ 72.05000000000001,\n        cart_turnovertaxincluded: 75.65,\n        items_list:\
    \ [\n          {\n            product_id: 'SKU_12345',\n            product: 'Stan\
    \ and Friends Tee',\n            product_variant: 'green',\n            product_discount:\
    \ true,\n            product_brand: 'Google',\n            product_category1:\
    \ 'Apparel',\n            product_category2: 'Adult',\n            product_category3:\
    \ 'Shirts',\n            product_category4: 'Crew',\n            product_quantity:\
    \ 3,\n            product_pricetaxfree: 10.01\n          },\n          {\n   \
    \         product_id: 'SKU_12346',\n            product: \"Google Grey Women's\
    \ Tee\",\n            product_variant: 'gray',\n            product_discount:\
    \ true,\n            product_brand: 'Google',\n            product_category1:\
    \ 'Apparel',\n            product_category2: 'Adult',\n            product_category3:\
    \ 'Shirts',\n            product_category4: 'Crew',\n            product_quantity:\
    \ 2,\n            product_pricetaxfree: 21.01,\n            onsitead_campaign:\
    \ 'P_12345',\n            onsitead_creation: 'Summer Sale'\n          }\n    \
    \    ],\n        cart_nbdistinctproduct: 2,\n        cart_quantity: 5\n      }\n\
    \    }\n  ]\n};\n\nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody)\
    \ => {\n  assertThat(requestUrl).isEqualTo(expectedRequestUrl);\n  assertThat(requestOptions).isEqualTo(expectedRequestOptions);\n\
    \  const requestBodyParsed = JSON.parse(requestBody);\n  assertThat(requestBodyParsed).isEqualTo(expectedRequestBody);\n\
    \  \n  return {\n    then: (callback) => { \n      callback({ statusCode: 200\
    \ });\n      return {\n        then: () => {},\n        catch: () => {}\n    \
    \  };\n    },\n    catch: (callback) => callback()\n  };\n});\n\nrunCode(mockData);\n\
    \nassertApi('gtmOnSuccess').wasCalled();\nassertApi('gtmOnFailure').wasNotCalled();"
- name: Inherited Event Name request is sent, but has errors - gtmOnFailure
  code: "mockData.eventType = 'inherit';\nmockGetAllEventDataWithPAData();\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {  \n  return {\n    then: (callback)\
    \ => { \n      callback({ statusCode: 400 });\n      return {\n        then: ()\
    \ => {},\n        catch: () => {}\n      };\n    },\n    catch: (callback) =>\
    \ callback()\n  };\n});\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasNotCalled();\n\
    assertApi('gtmOnFailure').wasCalled();"
- name: PA - Custom Event Name request is sent successfully if using Event Data from
    Piano Analytics Client - gtmOnSuccess
  code: "mockData.eventType = 'custom';\nconst expectedCustomEventName = 'expectedCustomEventName';\n\
    mockData.eventName = expectedCustomEventName;\nconst paEventData = mockGetAllEventDataWithPAData();\n\
    \nconst expectedRequestUrl = buildExpectedRequestUrl(expectedCollectionDomain,\
    \ expectedSiteId, paEventData.client_id);\nconst expectedRequestOptions = {\n\
    \  headers: {\n    'Content-Type': 'text/plain',\n    'X-Forwarded-For': expectedIpOverride,\n\
    \    'User-Agent': expectedUserAgent,\n    Referer: expectedPageLocation\n  },\n\
    \  method: 'POST'\n};\nconst expectedRequestBody = {\n  events: [\n    {\n   \
    \   name: expectedCustomEventName,\n      data: {\n        cart_id: 'LAPW221C',\n\
    \        cart_currency: 'EUR',\n        cart_turnovertaxincluded: 1399.9,\n  \
    \      cart_creation_utc: 1666196008,\n        cart_turnovertaxfree: 1120.9,\n\
    \        cart_quantity: 1,\n        cart_nbdistinctproduct: 1,\n        shipping_delivery:\
    \ 'Express',\n        shipping_costtaxincluded: 11.99,\n        shipping_costtaxfree:\
    \ 10.99,\n        transaction_id: 'TR221SI',\n        transaction_promocode: ['REDUC10'],\n\
    \        transaction_status: 'charged',\n        transaction_firstpurchase: true,\n\
    \        payment_mode: 'Credit card',\n        visitor_privacy_consent: true,\n\
    \        visitor_privacy_mode: 'optin',\n        event_collection_platform: 'js',\n\
    \        event_collection_version: '6.15.2',\n        device_timestamp_utc: 1746111402000,\n\
    \        device_local_hour: 1746111402000,\n        device_hour: 11,\n       \
    \ pageview_id: 'ma5ghrnf62e0irie',\n        content_title: 'Piano Analytics Developers\
    \ Documentation',\n        content_description: 'Events and properties',\n   \
    \     cookie_creation_date: '2025-04-28T00:00:00.000Z',\n        has_access: 'anon',\n\
    \        device_screen_width: 1512,\n        device_screen_height: 982,\n    \
    \    device_display_width: 317,\n        device_display_height: 772,\n       \
    \ browser_language: 'en',\n        browser_language_local: 'us',\n        previous_url:\
    \ 'https://example.com/',\n        page_title_html:\n          'How it works?\
    \ | Piano Analytics Developers Documentation',\n        event_url_full:\n    \
    \      'https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/how-it-works',\n\
    \        ch_ua: [\n          { brand: 'Google Chrome', version: '135' },\n   \
    \       { brand: 'Not-A.Brand', version: '8' },\n          { brand: 'Chromium',\
    \ version: '135' }\n        ],\n        ch_ua_arch: 'arm',\n        ch_ua_bitness:\
    \ '64',\n        ch_ua_full_version_list: [\n          { brand: 'Google Chrome',\
    \ version: '135.0.7049.115' },\n          { brand: 'Not-A.Brand', version: '8.0.0.0'\
    \ },\n          { brand: 'Chromium', version: '135.0.7049.115' }\n        ],\n\
    \        ch_ua_mobile: false,\n        ch_ua_model: '',\n        ch_ua_platform:\
    \ 'macOS',\n        ch_ua_platform_version: '15.2.0',\n        ch_ua_full_version:\
    \ '135.0.7049.115',\n        user_id: 'userid123',\n        user_category: 'testcategory',\n\
    \        user_recognition: false,\n        value: 1120.9\n      }\n    }\n  ]\n\
    };\n\nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody) => {\n\
    \  assertThat(requestUrl).isEqualTo(expectedRequestUrl);\n  assertThat(requestOptions).isEqualTo(expectedRequestOptions);\n\
    \  const requestBodyParsed = JSON.parse(requestBody);\n  assertThat(requestBodyParsed).isEqualTo(expectedRequestBody);\n\
    \  \n  return {\n    then: (callback) => { \n      callback({ statusCode: 200\
    \ });\n      return {\n        then: () => {},\n        catch: () => {}\n    \
    \  };\n    },\n    catch: (callback) => callback()\n  };\n});\n\nrunCode(mockData);\n\
    \nassertApi('gtmOnSuccess').wasCalled();\nassertApi('gtmOnFailure').wasNotCalled();"
- name: GA4 - Custom Event Name request is sent successfully if using Event Data from
    other client - gtmOnSuccess
  code: "mockData.eventType = 'custom';\nconst expectedCustomEventName = 'expectedCustomEventName';\n\
    mockData.eventName = expectedCustomEventName;\nconst gaEventData = mockGetAllEventDataWithGAData();\n\
    \nconst expectedRequestUrl = buildExpectedRequestUrl(expectedCollectionDomain,\
    \ expectedSiteId, gaEventData.client_id);\nconst expectedRequestOptions = {\n\
    \  headers: {\n    'Content-Type': 'text/plain',\n    'X-Forwarded-For': expectedIpOverride,\n\
    \    'User-Agent': expectedUserAgent,\n    Referer: expectedPageLocation\n  },\n\
    \  method: 'POST'\n};\nconst expectedRequestBody = {\n  events: [\n    {\n   \
    \   name: expectedCustomEventName,\n      data: {\n        device_timestamp_utc:\
    \ 1746111402,\n        cart_currency: 'USD',\n        browser_language: 'en',\n\
    \        browser_language_local: 'us',\n        event_url_full:\n          'https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/how-it-works',\n\
    \        previous_url: 'https://example.com/',\n        page_title_html: 'Example\
    \ Domain',\n        device_screen_width: 1512,\n        device_screen_height:\
    \ 982,\n        value: 72.05,\n        pageview_id: '1746024331702',\n       \
    \ shipping_costtaxfree: 5.99,\n        transaction_promocode: ['SUMMER_SALE'],\n\
    \        transaction_id: 'T_12345',\n        cart_id: 'T_12345',\n        items_list:\
    \ [\n          {\n            product_id: 'SKU_12345',\n            product: 'Stan\
    \ and Friends Tee',\n            product_variant: 'green',\n            product_discount:\
    \ true,\n            product_brand: 'Google',\n            product_category1:\
    \ 'Apparel',\n            product_category2: 'Adult',\n            product_category3:\
    \ 'Shirts',\n            product_category4: 'Crew',\n            product_quantity:\
    \ 3,\n            product_pricetaxfree: 10.01\n          },\n          {\n   \
    \         product_id: 'SKU_12346',\n            product: \"Google Grey Women's\
    \ Tee\",\n            product_variant: 'gray',\n            product_discount:\
    \ true,\n            product_brand: 'Google',\n            product_category1:\
    \ 'Apparel',\n            product_category2: 'Adult',\n            product_category3:\
    \ 'Shirts',\n            product_category4: 'Crew',\n            product_quantity:\
    \ 2,\n            product_pricetaxfree: 21.01,\n            onsitead_campaign:\
    \ 'P_12345',\n            onsitead_creation: 'Summer Sale'\n          }\n    \
    \    ]\n      }\n    }\n  ]\n};\n\nmock('sendHttpRequest', (requestUrl, requestOptions,\
    \ requestBody) => {\n  assertThat(requestUrl).isEqualTo(expectedRequestUrl);\n\
    \  assertThat(requestOptions).isEqualTo(expectedRequestOptions);\n  const requestBodyParsed\
    \ = JSON.parse(requestBody);\n  assertThat(requestBodyParsed).isEqualTo(expectedRequestBody);\n\
    \  \n  return {\n    then: (callback) => { \n      callback({ statusCode: 200\
    \ });\n      return {\n        then: () => {},\n        catch: () => {}\n    \
    \  };\n    },\n    catch: (callback) => callback()\n  };\n});\n\nrunCode(mockData);\n\
    \nassertApi('gtmOnSuccess').wasCalled();\nassertApi('gtmOnFailure').wasNotCalled();"
- name: Custom Event Name request is sent, but has errors - gtmOnFailure
  code: "mockData.eventType = 'custom';\nmockData.eventName = 'test';\nmockGetAllEventDataWithPAData();\n\
    \nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody) => {\n  return\
    \ {\n    then: (callback) => { \n      callback({ statusCode: 400 });\n      return\
    \ {\n        then: () => {},\n        catch: () => {}\n      };\n    },\n    catch:\
    \ (callback) => callback()\n  };\n});\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasNotCalled();\n\
    assertApi('gtmOnFailure').wasCalled();"
- name: IP Address is successfuly redacted if option is selected
  code: "mockData.eventType = 'inherit';\nmockData.redactIpAddress = true;\nconst\
    \ paEventData = mockGetAllEventDataWithPAData();\n\nconst expectedRequestOptions\
    \ = {\n  headers: {\n    'Content-Type': 'text/plain',\n    'User-Agent': expectedUserAgent,\n\
    \    Referer: expectedPageLocation\n  },\n  method: 'POST'\n};\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  assertThat(requestOptions).isEqualTo(expectedRequestOptions);\n\
    \n  return {\n    then: (callback) => { \n      callback({ statusCode: 200 });\n\
    \      return {\n        then: () => {},\n        catch: () => {}\n      };\n\
    \    },\n    catch: (callback) => callback()\n  };\n});\n\nrunCode(mockData);\n\
    \nassertApi('gtmOnSuccess').wasCalled();\nassertApi('gtmOnFailure').wasNotCalled();"
- name: Should log to console, if the 'Always log to console' option is selected
  code: "mockData.logType = 'always';\n\nconst expectedDebugMode = true;\nmock('getContainerVersion',\
    \ () => {\n  return {\n    debugMode: expectedDebugMode\n  };\n}); \n\nmock('logToConsole',\
    \ (logData) => {\n  const parsedLogData = JSON.parse(logData);\n  requiredConsoleKeys.forEach(p\
    \ => assertThat(parsedLogData[p]).isDefined());\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  return {\n    then: (callback)\
    \ => { \n      callback({ statusCode: 200 });\n      return {\n        then: ()\
    \ => {},\n        catch: () => {}\n      };\n    },\n    catch: (callback) =>\
    \ callback()\n  };\n});\n\nrunCode(mockData);\n\nassertApi('logToConsole').wasCalled();\n"
- name: Should log to console, if the 'Log during debug and preview' option is selected
    AND is on preview mode
  code: "mockData.logType = 'debug';\n\nconst expectedDebugMode = true;\nmock('getContainerVersion',\
    \ () => {\n  return {\n    debugMode: expectedDebugMode\n  };\n});\n\nmock('logToConsole',\
    \ (logData) => {\n  const parsedLogData = JSON.parse(logData);\n  requiredConsoleKeys.forEach(p\
    \ => assertThat(parsedLogData[p]).isDefined());\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  return {\n    then: (callback)\
    \ => { \n      callback({ statusCode: 200 });\n      return {\n        then: ()\
    \ => {},\n        catch: () => {}\n      };\n    },\n    catch: (callback) =>\
    \ callback()\n  };\n});\n\nrunCode(mockData);\n\nassertApi('logToConsole').wasCalled();\n"
- name: Should NOT log to console, if the 'Log during debug and preview' option is
    selected AND is NOT on preview mode
  code: "mockData.logType = 'debug';\n\nconst expectedDebugMode = false;\nmock('getContainerVersion',\
    \ () => {\n  return {\n    debugMode: expectedDebugMode\n  };\n}); \n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  return {\n    then: (callback)\
    \ => { \n      callback({ statusCode: 200 });\n      return {\n        then: ()\
    \ => {},\n        catch: () => {}\n      };\n    },\n    catch: (callback) =>\
    \ callback()\n  };\n});\n\nrunCode(mockData);\n\nassertApi('logToConsole').wasNotCalled();\n"
- name: Should NOT log to console, if the 'Do not log' option is selected
  code: "mockData.logType = 'no';\n\nmock('sendHttpRequest', (requestUrl, requestOptions,\
    \ requestBody) => {\n  return {\n    then: (callback) => { \n      callback({\
    \ statusCode: 200 });\n      return {\n        then: () => {},\n        catch:\
    \ () => {}\n      };\n    },\n    catch: (callback) => callback()\n  };\n});\n\
    \nrunCode(mockData);\n\nassertApi('logToConsole').wasNotCalled();\n"
- name: Should log to BQ, if the 'Log to BigQuery' option is selected
  code: "mockData.bigQueryLogType = 'always';\n\n// assertApi doesn't work for 'BigQuery.insert()'.\n\
    // Ref: https://gtm-gear.com/posts/gtm-templates-testing/\nmock('BigQuery', ()\
    \ => {\n  return { \n    insert: (connectionInfo, rows, options) => { \n     \
    \ assertThat(connectionInfo).isDefined();\n      assertThat(rows).isArray();\n\
    \      assertThat(rows).hasLength(1);\n      requiredBqKeys.forEach(p => assertThat(rows[0][p]).isDefined());\n\
    \      assertThat(options).isEqualTo(expectedBqOptions);\n      return Promise.create((resolve,\
    \ reject) => {\n        resolve();\n      });\n    }\n  };\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  return {\n    then: (callback)\
    \ => { \n      callback({ statusCode: 200 });\n      return {\n        then: ()\
    \ => {},\n        catch: () => {}\n      };\n    },\n    catch: (callback) =>\
    \ callback()\n  };\n});\n\nrunCode(mockData);"
- name: Should NOT log to BQ, if the 'Do not log to BigQuery' option is selected
  code: "mockData.bigQueryLogType = 'no';\n\n// assertApi doesn't work for 'BigQuery.insert()'.\n\
    // Ref: https://gtm-gear.com/posts/gtm-templates-testing/\nmock('BigQuery', ()\
    \ => {\n  return { \n    insert: (connectionInfo, rows, options) => { \n     \
    \ fail('BigQuery.insert should not have been called.');\n      return Promise.create((resolve,\
    \ reject) => {\n        resolve();\n      });\n    }\n  };\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  return {\n    then: (callback)\
    \ => { \n      callback({ statusCode: 200 });\n      return {\n        then: ()\
    \ => {},\n        catch: () => {}\n      };\n    },\n    catch: (callback) =>\
    \ callback()\n  };\n});\n\nrunCode(mockData);"
setup: "const JSON = require('JSON');\nconst Promise = require('Promise');\nconst\
  \ encodeUriComponent = require('encodeUriComponent');\n\nfunction mergeObj(target,\
  \ source) {\n  for (const key in source) {\n    if (source.hasOwnProperty(key))\
  \ target[key] = source[key];\n  }\n  return target;\n}\n\nfunction buildExpectedRequestUrl(collectionDomain,\
  \ siteId, idClient) {\n  return 'https://' + collectionDomain + '/event' + '?s='\
  \ + encodeUriComponent(siteId) + '&idclient=' + encodeUriComponent(idClient);\n\
  }\n\nconst expectedEventName = 'page.display';\nconst expectedCollectionDomain =\
  \ 'foobar.pa-cd.com';\nconst expectedSiteId = '123456789';\nconst expectedIdClient\
  \ = '05181c29-60fa-4381-b1bf-966e9f5dabca';\n\nconst expectedIpOverride = '123.123.123.123';\n\
  const expectedUserAgent = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36\
  \ (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36';\nconst expectedPageLocation\
  \ = 'https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/how-it-works';\n\
  \nconst expectedTraceIdHeader = 'traceidheader';\nmock('getRequestHeader', (header)\
  \ => {\n  if (header === 'trace-id') return expectedTraceIdHeader;\n});\n\nconst\
  \ mockGetAllEventDataWithGAData = (objToBeMerged) => {\n  const ga4EventData = mergeObj({\n\
  \    'x-ga-protocol_version': '2',\n    'x-ga-measurement_id': 'G-123ABC',\n   \
  \ 'x-ga-gtm_version': '45je54s1za200',\n    'x-ga-page_id': 1746024331702,\n   \
  \ 'x-ga-gcd': '13l3l3l3l1l1',\n    'x-ga-npa': '0',\n    'x-ga-dma': '0',\n    'x-ga-mp2-tag_exp':\n\
  \      '103051953~103077950~103106314~103106316~103116026~103173737~103173739~103200004',\n\
  \    client_id: 'XFqqXs1ZfJHSgOb6kbO7NlBmEyhCotbBTcMt0Uum4fs=.1746024332',\n   \
  \ 'x-ga-ecid': '641290227',\n    language: 'en-us',\n    screen_resolution: '1512x982',\n\
  \    event_location: { country: 'BR', region: 'SP' },\n    client_hints: {\n   \
  \   architecture: 'arm',\n      bitness: '64',\n      full_version_list: [\n   \
  \     { brand: 'Google Chrome', version: '135.0.7049.115' },\n        { brand: 'Not-A.Brand',\
  \ version: '8.0.0.0' },\n        { brand: 'Chromium', version: '135.0.7049.115'\
  \ }\n      ],\n      mobile: false,\n      model: '',\n      platform: 'macOS',\n\
  \      platform_version: '15.2.0',\n      wow64: false,\n      brands: [\n     \
  \   { brand: 'Google Chrome', version: '135' },\n        { brand: 'Not-A.Brand',\
  \ version: '8' },\n        { brand: 'Chromium', version: '135' }\n      ]\n    },\n\
  \    'x-ga-are': '1',\n    'x-ga-mp2-frm': '0',\n    'x-ga-pscdl': 'noapi',\n  \
  \  'x-ga-system_properties': { eu: [33], tu: 'BA', ee: true },\n    'x-sst-system_properties':\
  \ {\n      etld: 'google.com.br',\n      tft: '1746024331702',\n      lpc: '60493049',\n\
  \      navt: 'n',\n      ude: '0',\n      sw_exp: '1',\n      request_start_time_ms:\
  \ 1746108517526\n    },\n    'x-ga-request_count': 28,\n    currency: 'USD',\n \
  \   ga_session_id: '1746108308',\n    ga_session_number: 3,\n    'x-ga-mp2-seg':\
  \ '0',\n    page_location: expectedPageLocation,\n    page_referrer: 'https://example.com/',\n\
  \    page_title: 'Example Domain',\n    event_name: 'purchase',\n    items: [\n\
  \      {\n        item_id: 'SKU_12345',\n        item_name: 'Stan and Friends Tee',\n\
  \        affiliation: 'Google Merchandise Store',\n        coupon: 'SUMMER_FUN',\n\
  \        discount: 2.22,\n        index: 0,\n        item_brand: 'Google',\n   \
  \     item_category: 'Apparel',\n        item_category2: 'Adult',\n        item_category3:\
  \ 'Shirts',\n        item_category4: 'Crew',\n        item_category5: 'Short sleeve',\n\
  \        item_list_id: 'related_products',\n        item_list_name: 'Related Products',\n\
  \        item_variant: 'green',\n        location_id: 'ChIJIQBpAG2ahYAR_6128GcTUEo',\n\
  \        price: 10.01,\n        quantity: 3\n      },\n      {\n        item_id:\
  \ 'SKU_12346',\n        item_name: \"Google Grey Women's Tee\",\n        affiliation:\
  \ 'Google Merchandise Store',\n        coupon: 'SUMMER_FUN',\n        discount:\
  \ 3.33,\n        index: 1,\n        item_brand: 'Google',\n        item_category:\
  \ 'Apparel',\n        item_category2: 'Adult',\n        item_category3: 'Shirts',\n\
  \        item_category4: 'Crew',\n        item_category5: 'Short sleeve',\n    \
  \    item_list_id: 'related_products',\n        item_list_name: 'Related Products',\n\
  \        item_variant: 'gray',\n        location_id: 'ChIJIQBpAG2ahYAR_6128GcTUEo',\n\
  \        price: 21.01,\n        promotion_id: 'P_12345',\n        promotion_name:\
  \ 'Summer Sale',\n        quantity: 2\n      }\n    ],\n    transaction_id: 'T_12345',\n\
  \    value: 72.05,\n    tax: 3.6,\n    shipping: 5.99,\n    coupon: 'SUMMER_SALE',\n\
  \    'x-ga-tfd': 15033364,\n    ip_override: expectedIpOverride,\n    user_agent:\
  \ expectedUserAgent\n  }, objToBeMerged);\n  \n  mock('getTimestampMillis', 1746111402000);\n\
  \  \n  mock('getAllEventData', () => {\n    return ga4EventData;\n  });\n  \n  return\
  \ ga4EventData;\n};\n\nconst mockGetAllEventDataWithPAData = (objToBeMerged) =>\
  \ {\n  const paEventData = mergeObj({\n    event_name: 'transaction.confirmation',\n\
  \    client_id: '05181c29-60fa-4381-b1bf-966e9f5dabca',\n    ip_override: expectedIpOverride,\n\
  \    currency: 'EUR',\n    language: 'en-us',\n    page_hostname: 'developers.atinternet-solutions.com',\n\
  \    page_location: expectedPageLocation,\n    page_path: '/piano-analytics/data-collection/general/how-it-works',\n\
  \    page_referrer: 'https://example.com/',\n    page_title: 'How it works? | Piano\
  \ Analytics Developers Documentation',\n    screen_resolution: '1512x982',\n   \
  \ user_agent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36\
  \ (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36',\n    user_id: 'userid123',\n\
  \    value: 1120.9,\n    viewport_size: '317x772',\n    'x-pa-site-id': expectedSiteId,\n\
  \    'x-pa-idclient': expectedIdClient,\n    'x-pa-data': {\n      cart_id: 'LAPW221C',\n\
  \      cart_currency: 'EUR',\n      cart_turnovertaxincluded: 1399.9,\n      cart_creation_utc:\
  \ 1666196008,\n      cart_turnovertaxfree: 1120.9,\n      cart_quantity: 1,\n  \
  \    cart_nbdistinctproduct: 1,\n      shipping_delivery: 'Express',\n      shipping_costtaxincluded:\
  \ 11.99,\n      shipping_costtaxfree: 10.99,\n      transaction_id: 'TR221SI',\n\
  \      transaction_promocode: ['REDUC10'],\n      transaction_status: 'charged',\n\
  \      transaction_firstpurchase: true,\n      payment_mode: 'Credit card',\n  \
  \    visitor_privacy_consent: true,\n      visitor_privacy_mode: 'optin',\n    \
  \  event_collection_platform: 'js',\n      event_collection_version: '6.15.2',\n\
  \      device_timestamp_utc: 1746111402000,\n      device_local_hour: 1746111402000,\n\
  \      device_hour: 11,\n      pageview_id: 'ma5ghrnf62e0irie',\n      content_title:\
  \ 'Piano Analytics Developers Documentation',\n      content_description: 'Events\
  \ and properties',\n      cookie_creation_date: '2025-04-28T00:00:00.000Z',\n  \
  \    has_access: 'anon',\n      device_screen_width: 1512,\n      device_screen_height:\
  \ 982,\n      device_display_width: 317,\n      device_display_height: 772,\n  \
  \    browser_language: 'en',\n      browser_language_local: 'US',\n      previous_url:\
  \ 'https://example.com/',\n      page_title_html: 'How it works? | Piano Analytics\
  \ Developers Documentation',\n      event_url_full:\n        'https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/how-it-works',\n\
  \      ch_ua: [\n        { brand: 'Google Chrome', version: '135' },\n        {\
  \ brand: 'Not-A.Brand', version: '8' },\n        { brand: 'Chromium', version: '135'\
  \ }\n      ],\n      ch_ua_arch: 'arm',\n      ch_ua_bitness: '64',\n      ch_ua_full_version_list:\
  \ [\n        { brand: 'Google Chrome', version: '135.0.7049.115' },\n        { brand:\
  \ 'Not-A.Brand', version: '8.0.0.0' },\n        { brand: 'Chromium', version: '135.0.7049.115'\
  \ }\n      ],\n      ch_ua_mobile: false,\n      ch_ua_model: '',\n      ch_ua_platform:\
  \ 'macOS',\n      ch_ua_platform_version: '15.2.0',\n      ch_ua_full_version: '135.0.7049.115',\n\
  \      user_id: 'userid123',\n      user_category: 'testcategory',\n      user_recognition:\
  \ false\n    }\n  }, objToBeMerged);\n  \n  mock('getAllEventData', () => {\n  \
  \  return paEventData;\n  });\n  \n return paEventData;\n};\n\nconst expectedBigQuerySettings\
  \ = {\n  logBigQueryProjectId: 'logBigQueryProjectId',\n  logBigQueryDatasetId:\
  \ 'logBigQueryDatasetId',\n  logBigQueryTableId: 'logBigQueryTableId'\n};\nconst\
  \ requiredConsoleKeys = ['Type', 'TraceId', 'Name'];\nconst requiredBqKeys = ['timestamp',\
  \ 'type', 'trace_id', 'tag_name'];\nconst expectedBqOptions = { ignoreUnknownValues:\
  \ true };\n\nconst mockData = {\n  eventType: 'custom',\n  eventName: expectedEventName,\n\
  \  collectionDomain: expectedCollectionDomain,\n  siteId: expectedSiteId,\n  logBigQueryProjectId:\
  \ expectedBigQuerySettings.logBigQueryProjectId,\n  logBigQueryDatasetId: expectedBigQuerySettings.logBigQueryDatasetId,\n\
  \  logBigQueryTableId: expectedBigQuerySettings.logBigQueryTableId\n};"


___NOTES___

Created on 5/1/2025, 1:45:40 PM

